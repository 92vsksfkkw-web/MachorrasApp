<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
<!-- Configuración para que funcione como App sin servidor -->
<meta name="mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="apple-mobile-web-app-title" content="Machorras" />
<meta name="theme-color" content="#022c22" />
<!-- Iconos: Usamos la imagen directa para el icono de la app -->
<link rel="apple-touch-icon" href="https://i.ibb.co/4nmPJsHC/image.jpg" />
<link rel="icon" type="image/jpeg" href="https://i.ibb.co/4nmPJsHC/image.jpg" />
<title>Torneo Machorras</title>
<script src="https://cdn.tailwindcss.com"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import {
  getFirestore,
  doc,
  setDoc,
  onSnapshot,
  collection,
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
import {
  getAuth,
  signInAnonymously,
  signInWithCustomToken,
  onAuthStateChanged,
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

// Configuración de Firebase (configuración directa)
const firebaseConfig = {
  apiKey: "AIzaSyAF000OYEtb-7Ytr6N8P4GMWts0Z-QY75o",
  authDomain: "machorraspadel-2b719.firebaseapp.com",
  projectId: "machorraspadel-2b719",
  storageBucket: "machorraspadel-2b719.appspot.com",
  messagingSenderId: "1083631789467",
  appId: "1:1083631789467:web:d4922959096858d54bad3e",
  measurementId: "G-FGFR2N2X28"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const appId = "torneo-machorras";

let currentUser = null;
let localResultados = {};
let currentView = { type: "ronda", value: 1 };
let isFirstLoad = true;

// Autenticación silenciosa para persistencia de datos
const initAuth = async () => {
  try {
    if (typeof __initial_auth_token !== "undefined" && __initial_auth_token) {
      await signInWithCustomToken(auth, __initial_auth_token);
    } else {
      await signInAnonymously(auth);
    }
  } catch (error) {
    console.error("Error de auth:", error);
  }
};

onAuthStateChanged(auth, (user) => {
  if (user) {
    currentUser = user;
    const resultsRef = collection(db, "artifacts", appId, "public", "data", "resultados");
    onSnapshot(resultsRef, (snapshot) => {
      const nuevosResultados = {};
      snapshot.forEach((doc) => { nuevosResultados[doc.id] = doc.data().scores; });
      localResultados = nuevosResultados;
      if (isFirstLoad) {
        isFirstLoad = false;
        window.initButtons();
        window.setCurrentView("ronda", 1);
      } else {
        refreshCurrentView();
      }
    }, (error) => console.error("Error Firestore:", error));
  }
});

initAuth();

const refreshCurrentView = () => {
  if (currentView.type === "ronda") window.renderRonda(currentView.value);
  else if (currentView.type === "ranking") window.renderClasificacion();
};

window.saveScore = async (ronda, partidoIdx, parejaPos, value) => {
  if (!currentUser) return;
  const rKey = ronda.toString();
  const valInt = (value === "" || value === null || isNaN(value)) ? null : parseInt(value);
  if (!localResultados[rKey]) localResultados[rKey] = {};
  if (!localResultados[rKey][partidoIdx]) localResultados[rKey][partidoIdx] = [null, null];
  localResultados[rKey][partidoIdx][parejaPos] = valInt;
  try {
    const docRef = doc(db, "artifacts", appId, "public", "data", "resultados", rKey);
    await setDoc(docRef, { scores: localResultados[rKey], updatedAt: Date.now() }, { merge: true });
  } catch (e) { console.error(e); }
};

window.clearMatch = async (ronda, partidoIdx) => {
  if (!currentUser) return;
  const rKey = ronda.toString();
  if (localResultados[rKey] && localResultados[rKey][partidoIdx]) {
    localResultados[rKey][partidoIdx] = [null, null];
    try {
      const docRef = doc(db, "artifacts", appId, "public", "data", "resultados", rKey);
      await setDoc(docRef, { scores: localResultados[rKey], updatedAt: Date.now() }, { merge: true });
      refreshCurrentView();
    } catch (e) { console.error(e); }
  }
};

window.getResultados = () => localResultados;

window.setCurrentView = (type, value) => {
  currentView = { type, value };
  refreshCurrentView();
};
</script>
<style>
@import url("https://fonts.googleapis.com/css2?family=Fira+Sans:wght@900&family=Inter:wght@400;700;800&display=swap");
:root {
  --brand-green: #22c55e;
  --brand-dark: #064e3b;
  --brand-bg: #022c22;
  --blue-card-bg: rgba(30, 58, 138, 0.4);
}
body {
  font-family: "Inter", sans-serif;
  background-color: var(--brand-bg);
  color: white;
  -webkit-tap-highlight-color: transparent;
  overflow-x: hidden;
  margin: 0;
  padding: 0;
}
.header-main {
  background: linear-gradient(to bottom, #064e3b 0%, #022c22 100%);
  padding: 4rem 1rem 4rem 1rem;
  text-align: center;
}
.font-logo-heavy {
  font-family: "Fira Sans", sans-serif;
  font-weight: 900;
  text-transform: uppercase;
  letter-spacing: -0.05em;
  line-height: 0.85;
  text-shadow: 0px 8px 20px rgba(0, 0, 0, 0.5);
}
.profile-circle-large {
  width: 140px; height: 140px;
  margin: 0 auto 1.5rem auto;
  background-color: #032d23;
  border-radius: 50%;
  border: 4px solid white;
  overflow: hidden;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.7);
}
.profile-circle-large img {
  width: 100%; height: 100%;
  object-fit: cover;
  transform: scale(1.4);
  object-position: center 15%;
}
.sticky-nav {
  position: sticky; top: 1rem; z-index: 50;
  margin: -2.5rem 1rem 1.5rem 1rem;
  background-color: rgba(6, 78, 59, 0.9);
  backdrop-filter: blur(15px);
  padding: 0.75rem;
  border-radius: 2rem;
  border: 1px solid rgba(255,255,255,0.1);
}
.nav-container { display: flex; gap: 0.5rem; overflow-x: auto; scrollbar-width: none; }
.nav-container::-webkit-scrollbar { display: none; }
.btn-ronda-base {
  background: rgba(255,255,255,0.05);
  color: white; padding: 0.7rem 1.3rem;
  border-radius: 1rem; font-size: 11px; font-weight: 800;
  text-transform: uppercase; white-space: nowrap; transition: all 0.2s;
}
.active-ronda {
  background: var(--brand-green) !important;
  box-shadow: 0 0 15px rgba(34, 197, 94, 0.5);
}
.match-card {
  background: var(--blue-card-bg);
  border: 1px solid rgba(255,255,255,0.05);
  border-radius: 1.25rem; padding: 1rem; margin-bottom: 1rem;
}
.match-card.completed {
  border-left: 5px solid var(--brand-green);
  background: rgba(30, 58, 138, 0.6);
}
.pista-label {
  font-size: 9px; font-weight: 900; text-transform: uppercase;
  color: var(--brand-green); letter-spacing: 0.15em;
  margin-bottom: 0.6rem; display: block;
}
.team-row { display: flex; align-items: center; justify-content: space-between; height: 2.5rem; }
.team-name {
  font-size: 0.85rem; font-weight: 700; text-transform: uppercase;
  color: rgba(255,255,255,0.9); max-width: 65%;
  overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
}
input {
  background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.1);
  color: var(--brand-green); font-weight: 900; width: 3.8rem; height: 2.2rem;
  border-radius: 0.6rem; text-align: center; font-size: 1.1rem;
}
.ranking-box {
  background: var(--blue-card-bg); border-radius: 1.5rem;
  overflow: hidden; margin-bottom: 2rem; border: 1px solid rgba(255,255,255,0.1);
}
table { width: 100%; border-collapse: collapse; }
th {
  font-size: 10px; color: var(--brand-green);
  padding: 1.25rem 1rem; text-transform: uppercase;
}
td {
  padding: 1rem; border-bottom: 1px solid rgba(255,255,255,0.05);
}
.pts-column {
  font-size: 1.3rem;
  font-family: 'Fira Sans', sans-serif;
  font-weight: 900;
  color: white;
}
</style>
</head>
<body class="pb-24">
<header class="header-main">
  <div class="profile-circle-large">
    <img src="https://i.ibb.co/4nmPJsHC/image.jpg" alt="Logo Machorras" />
  </div>
  <h1 class="text-6xl font-logo-heavy text-white">MACHORRAS</h1>
  <p class="text-[10px] font-black uppercase tracking-[0.6em] text-green-400 mt-2">AMERICANO PADEL</p>
</header>
<div class="sticky-nav">
  <div class="nav-container">
    <div id="buttons-rondas" class="flex gap-2"></div>
    <div class="w-px h-6 bg-white/10 self-center mx-1"></div>
    <button onclick="window.setCurrentView('ranking', null)" id="btn-ranking" class="btn-ronda-base">Ranking</button>
  </div>
</div>
<main id="main-content" class="px-4 max-w-lg mx-auto"></main>
<script>
const parejas = {
  1: "Martina y Delfina", 2: "Gabinete Machorril", 3: "Azúcar Moreno", 4: "Golden Point",
  5: "AR en la Red", 6: "Las Rebotonas", 7: "Two Strangers", 8: "Padeleo",
  9: "Red Flag", 10: "Valkirias", 11: "Las Chinchillas", 12: "Las PY",
  13: "Last Call", 14: "Red Queens", 15: "Las Dejaditas Letales", 16: "Chuchi's Team",
  17: "Zipi y Zape", 18: "Las de la última bola", 19: "Bolitas", 20: "The Twins"
};
const rondasData = {
  1: { cruces: [[1,11], [20,10], [2,12], [19,9], [3,13], [18,8], [4,14], [17,7], [5,15], [16,6]] },
  2: { cruces: [[5,16], [1,10], [11,12], [20,9], [2,13], [19,8], [3,14], [18,7], [4,15], [17,6]] },
  3: { cruces: [[4,16], [17,5], [1,12], [10,9], [11,13], [20,8], [2,14], [19,7], [3,15], [18,6]] },
  4: { cruces: [[3,16], [18,5], [4,17], [1,9], [12,13], [10,8], [11,14], [20,7], [2,15], [19,6]] },
  5: { cruces: [[2,16], [19,5], [3,17], [18,4], [1,13], [9,8], [12,14], [10,7], [11,15], [20,6]] },
  6: { cruces: [[11,16], [20,5], [2,17], [19,4], [3,18], [1,8], [13,14], [9,7], [12,15], [10,6]] },
  7: { cruces: [[12,16], [10,5], [11,17], [20,4], [2,18], [19,3], [1,14], [8,7], [13,15], [9,6]] },
  8: { cruces: [[13,16], [9,5], [12,17], [10,4], [11,18], [20,3], [2,19], [1,7], [14,15], [8,6]] },
  9: { cruces: [[14,16], [8,5], [13,17], [9,4], [12,18], [10,3], [11,19], [20,2], [1,15], [7,6]] },
  10: { cruces: [[15,16], [7,5], [14,17], [8,4], [13,18], [9,3], [12,19], [10,2], [11,20], [1,6]] }
};
window.initButtons = () => {
  const container = document.getElementById("buttons-rondas");
  if (!container) return;
  container.innerHTML = "";
  for (let i = 1; i <= 10; i++) {
    const btn = document.createElement("button");
    btn.id = `btn-${i}`;
    btn.onclick = () => window.setCurrentView("ronda", i);
    btn.className = "btn-ronda-base";
    btn.innerText = `R${i}`;
    container.appendChild(btn);
  }
};
window.renderRonda = (num) => {
  const container = document.getElementById("main-content");
  if (!container) return;
  const data = rondasData[num];
  const resultados = window.getResultados();
  const rKey = num.toString();
  let html = `<div class="pb-10">`;
  data.cruces.forEach((cruce, idx) => {
    const matchScores = (resultados[rKey] && resultados[rKey][idx]) ? resultados[rKey][idx] : [null, null];
    const s1 = (matchScores[0] !== null) ? matchScores[0] : "";
    const s2 = (matchScores[1] !== null) ? matchScores[1] : "";
    const isComplete = s1 !== "" && s2 !== "";
    html += `
    <div class="match-card ${isComplete ? 'completed' : ''}">
      <span class="pista-label">Pista ${idx + 1}</span>
      <div class="team-row mb-1">
        <span class="team-name">${parejas[cruce[0]]}</span>
        <input type="number" placeholder="0" value="${s1}" oninput="window.saveScore(${num},${idx},0,this.value)">
      </div>
     
