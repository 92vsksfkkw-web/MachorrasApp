<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
<meta name="mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="apple-mobile-web-app-title" content="Machorras" />
<meta name="theme-color" content="#022c22" />

<link rel="manifest" href="manifest.json" />
<link rel="apple-touch-icon" href="https://i.ibb.co/938ThK0C/192x192.png" />
<link rel="icon" type="image/png" href="https://i.ibb.co/938ThK0C/192x192.png" />

<title>Torneo Machorras</title>
<script src="https://cdn.tailwindcss.com"></script>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

// Credenciales inyectadas directamente para GitHub Pages
const supabaseUrl = "https://sxtgzpzneqyaxljpkqmb.supabase.co";
const supabaseAnonKey = "sb_publishable_mrrBNQvb9QKx4pfkSMoSuQ_IxtFSaaX";
const supabase = createClient(supabaseUrl, supabaseAnonKey);

let currentUser = null;
let localResultados = {};
let currentView = { type: "ronda", value: 1 };
let isFirstLoad = true;

// Registro service worker
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('service-worker.js').catch(err => console.warn('SW error:', err));
  });
}

const initAuth = async () => {
  try {
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) {
      await supabase.auth.signInAnonymously();
    }
  } catch (error) {
    console.error("Error de auth:", error);
  }
};

const loadResultados = async () => {
  try {
    const { data, error } = await supabase.from("resultados").select("*");
    if (error) throw error;
    const nuevosResultados = {};
    data.forEach((row) => {
      const rKey = row.ronda.toString();
      if (!nuevosResultados[rKey]) nuevosResultados[rKey] = {};
      nuevosResultados[rKey][row.partido_idx] = row.scores;
    });
    localResultados = nuevosResultados;
    return true;
  } catch (error) {
    console.error("Error cargando resultados:", error);
    return false;
  }
};

const subscribeToChanges = () => {
  supabase.channel("resultados_changes")
    .on("postgres_changes", { event: "*", schema: "public", table: "resultados" }, (payload) => {
        const rKey = payload.new.ronda.toString();
        if (!localResultados[rKey]) localResultados[rKey] = {};
        localResultados[rKey][payload.new.partido_idx] = payload.new.scores;
        refreshCurrentView();
    }).subscribe();
};

supabase.auth.onAuthStateChanged(async (event, session) => {
  const user = session?.user;
  if (user) {
    currentUser = user;
    const loaded = await loadResultados();
    if (loaded) {
      subscribeToChanges();
      if (isFirstLoad) {
        isFirstLoad = false;
        window.initButtons();
        window.setCurrentView("ronda", 1);
      } else {
        refreshCurrentView();
      }
    }
  }
});

initAuth();

const refreshCurrentView = () => {
  if (currentView.type === "ronda") window.renderRonda(currentView.value);
  else if (currentView.type === "ranking") window.renderClasificacion();
};

window.saveScore = async (ronda, partidoIdx, parejaPos, value) => {
  if (!currentUser) return;
  const valInt = (value === "" || value === null || isNaN(value)) ? null : parseInt(value);
  const rKey = ronda.toString();
  if (!localResultados[rKey]) localResultados[rKey] = {};
  if (!localResultados[rKey][partidoIdx]) localResultados[rKey][partidoIdx] = [null, null];
  localResultados[rKey][partidoIdx][parejaPos] = valInt;

  try {
    await supabase.from("resultados").upsert(
      { ronda, partido_idx: partidoIdx, scores: localResultados[rKey][partidoIdx] },
      { onConflict: "ronda,partido_idx" }
    );
  } catch (e) { console.error(e); }
};

window.clearMatch = async (ronda, partidoIdx) => {
  if (!currentUser) return;
  const rKey = ronda.toString();
  if (localResultados[rKey]) {
    localResultados[rKey][partidoIdx] = [null, null];
    try {
      await supabase.from("resultados").upsert(
        { ronda, partido_idx: partidoIdx, scores: [null, null] },
        { onConflict: "ronda,partido_idx" }
      );
      refreshCurrentView();
    } catch (e) { console.error(e); }
  }
};

window.getResultados = () => localResultados;
window.setCurrentView = (type, value) => {
  currentView = { type, value };
  refreshCurrentView();
};

const parejas = {
  1: "Martina y Delfina", 2: "Gabinete Machorril", 3: "AzÃºcar Moreno", 4: "Golden Point",
  5: "AR en la Red", 6: "Las Rebotonas", 7: "Two Strangers", 8: "Padeleo",
  9: "Red Flag", 10: "Valkirias", 11: "Las Chinchillas", 12: "Las PY",
  13: "Last Call", 14: "Red Queens", 15: "Las Dejaditas Letales", 16: "Chuchi's Team",
  17: "Zipi y Zape", 18: "Las de la Ãºltima bola", 19: "Bolitas", 20: "The Twins"
};

const rondasData = {
  1: { cruces: [[1,11], [20,10], [2,12], [19,9], [3,13], [18,8], [4,14], [17,7], [5,15], [16,6]] },
  2: { cruces: [[5,16], [1,10], [11,12], [20,9], [2,13], [19,8], [3,14], [18,7], [4,15], [17,6]] },
  3: { cruces: [[4,16], [17,5], [1,12], [10,9], [11,13], [20,8], [2,14], [19,7], [3,15], [18,6]] },
  4: { cruces: [[3,16], [18,5], [4,17], [1,9], [12,13], [10,8], [11,14], [20,7], [2,15], [19,6]] },
  5: { cruces: [[2,16], [19,5], [3,17], [18,4], [1,13], [9,8], [12,14], [10,7], [11,15], [20,6]] },
  6: { cruces: [[11,16], [20,5], [2,17], [19,4], [3,18], [1,8], [13,14], [9,7], [12,15], [10,6]] },
  7: { cruces: [[12,16], [10,5], [11,17], [20,4], [2,18], [19,3], [1,14], [8,7], [13,15], [9,6]] },
  8: { cruces: [[13,16], [9,5], [12,17], [10,4], [11,18], [20,3], [2,19], [1,7], [14,15], [8,6]] },
  9: { cruces: [[14,16], [8,5], [13,17], [9,4], [12,18], [10,3], [11,19], [20,2], [1,15], [7,6]] },
  10: { cruces: [[15,16], [7,5], [14,17], [8,4], [13,18], [9,3], [12,19], [10,2], [11,20], [1,6]] }
};

window.initButtons = () => {
  const container = document.getElementById("buttons-rondas");
  if (!container) return;
  container.innerHTML = "";
  for (let i = 1; i <= 10; i++) {
    const btn = document.createElement("button");
    btn.id = `btn-${i}`;
    btn.onclick = () => window.setCurrentView("ronda", i);
    btn.className = "btn-ronda-base";
    btn.innerText = `R${i}`;
    container.appendChild(btn);
  }
};

window.renderRonda = (num) => {
  const container = document.getElementById("main-content");
  if (!container) return;
  const data = rondasData[num];
  const resultados = window.getResultados();
  const rKey = num.toString();
  let html = `<div class="pb-10">`;
  data.cruces.forEach((cruce, idx) => {
    const matchScores = (resultados[rKey] && resultados[rKey][idx]) ? resultados[rKey][idx] : [null, null];
    const s1 = (matchScores[0] !== null) ? matchScores[0] : "";
    const s2 = (matchScores[1] !== null) ? matchScores[1] : "";
    const isComplete = s1 !== "" && s2 !== "";
    html += `
      <div class="match-card ${isComplete ? 'completed' : ''}">
        <span class="pista-label">Pista ${idx + 1}</span>
        <div class="team-row mb-1">
          <span class="team-name">${parejas[cruce[0]]}</span>
          <input type="number" placeholder="0" value="${s1}" oninput="window.saveScore(${num},${idx},0,this.value)">
        </div>
        <div class="team-row">
          <span class="team-name">${parejas[cruce[1]]}</span>
          <input type="number" placeholder="0" value="${s2}" oninput="window.saveScore(${num},${idx},1,this.value)">
        </div>
        <a href="javascript:void(0)" class="clear-link text-[10px] opacity-30 block text-right mt-2" onclick="window.clearMatch(${num},${idx})">Borrar</a>
      </div>`;
  });
  container.innerHTML = html + "</div>";
  updateNavUI(num);
};

window.renderClasificacion = () => {
  const container = document.getElementById("main-content");
  if (!container) return;
  const resultados = window.getResultados();
  const stats = {};
  for (let i = 1; i <= 20; i++) stats[i] = { id: i, nombre: parejas[i], total: 0, jugados: 0 };
  for (let r = 1; r <= 10; r++) {
    const rRes = resultados[r.toString()];
    if (!rRes) continue;
    rondasData[r].cruces.forEach((cruce, pIdx) => {
      const scoreArr = rRes[pIdx];
      if (scoreArr) {
        if (scoreArr[0] !== null && scoreArr[0] !== "") { stats[cruce[0]].total += parseInt(scoreArr[0]); stats[cruce[0]].jugados++; }
        if (scoreArr[1] !== null && scoreArr[1] !== "") { stats[cruce[1]].total += parseInt(scoreArr[1]); stats[cruce[1]].jugados++; }
      }
    });
  }
  const sorted = Object.values(stats).sort((a, b) => b.total - a.total);
  let html = `<div class="ranking-box"><table><thead><tr><th>#</th><th class="text-left">Pareja</th><th>PJ</th><th>Puntos</th></tr></thead><tbody>`;
  sorted.forEach((p, i) => {
    let pos = i + 1;
    if (i === 0) pos = 'ðŸ¥‡'; else if (i === 1) pos = 'ðŸ¥ˆ'; else if (i === 2) pos = 'ðŸ¥‰';
    html += `<tr><td class="text-center font-bold">${pos}</td><td class="font-bold text-sm uppercase">${p.nombre}</td><td class="text-center text-xs opacity-50">${p.jugados}</td><td class="text-center pts-column">${p.total}</td></tr>`;
  });
  container.innerHTML = html + "</tbody></table></div>";
  updateNavUI("ranking");
};

function updateNavUI(active) {
  for (let i = 1; i <= 10; i++) {
    const btn = document.getElementById(`btn-${i}`);
    if (btn) btn.classList.toggle("active-ronda", active === i);
  }
  const rb = document.getElementById('btn-ranking');
  if (rb) rb.classList.toggle("active-ronda", active === "ranking");
}
</script>

<style>
@import url("https://fonts.googleapis.com/css2?family=Fira+Sans:wght@900&family=Inter:wght@400;700;800&display=swap");
:root { --brand-green: #22c55e; --brand-bg: #022c22; --blue-card-bg: rgba(30, 58, 138, 0.4); }
body { font-family: "Inter", sans-serif; background-color: var(--brand-bg); color: white; margin: 0; padding: 0; overflow-x: hidden; }
.header-main { background: linear-gradient(to bottom, #064e3b 0%, #022c22 100%); padding: 3rem 1rem; text-align: center; }
.font-logo-heavy { font-family: "Fira Sans", sans-serif; font-weight: 900; text-transform: uppercase; font-size: 3rem; text-shadow: 0px 8px 20px rgba(0,0,0,0.5); }
.profile-circle-large { width: 120px; height: 120px; margin: 0 auto 1rem; background-color: #032d23; border-radius: 50%; border: 4px solid white; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.7); }
.profile-circle-large img { width: 100%; height: 100%; object-fit: cover; }
.sticky-nav { position: sticky; top: 0; z-index: 50; background: rgba(6, 78, 59, 0.95); backdrop-filter: blur(15px); padding: 0.75rem; border-bottom: 1px solid rgba(255,255,255,0.1); }
.nav-container { display: flex; gap: 0.5rem; overflow-x: auto; scrollbar-width: none; }
.btn-ronda-base { background: rgba(255,255,255,0.05); color: white; padding: 0.6rem 1rem; border-radius: 0.8rem; font-size: 12px; font-weight: 800; white-space: nowrap; }
.active-ronda { background: var(--brand-green) !important; color: black !important; box-shadow: 0 0 15px rgba(34, 197, 94, 0.5); }
.match-card { background: var(--blue-card-bg); border-radius: 1rem; padding: 1rem; margin-bottom: 1rem; border: 1px solid rgba(255,255,255,0.05); }
.match-card.completed { border-left: 5px solid var(--brand-green); }
.team-row { display: flex; align-items: center; justify-content: space-between; height: 2.5rem; }
.team-name { font-size: 14px; font-weight: bold; }
input { width: 50px; height: 35px; background: white; color: black; text-align: center; border-radius: 6px; font-weight: bold; border: none; }
.ranking-box table { width: 100%; border-collapse: collapse; }
.ranking-box td { padding: 12px 8px; border-bottom: 1px solid rgba(255,255,255,0.05); }
.pts-column { color: var(--brand-green); font-size: 20px; font-weight: 900; }
</style>
</head>
<body>
  <header class="header-main">
    <div class="profile-circle-large">
      <img src="https://i.ibb.co/938ThK0C/192x192.png" alt="Logo">
    </div>
    <h1 class="font-logo-heavy">MACHORRAS</h1>
    <p class="text-xs opacity-60 uppercase tracking-widest mt-2">Torneo Primavera 2024</p>
  </header>

  <nav class="sticky-nav">
    <div class="nav-container" id="buttons-rondas"></div>
    <button onclick="window.setCurrentView('ranking')" id="btn-ranking" class="btn-ronda-base w-full mt-3">VER CLASIFICACIÃ“N GENERAL</button>
  </nav>

  <main id="main-content" class="p-4"></main>

</body>
</html>
