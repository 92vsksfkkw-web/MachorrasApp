<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
<meta name="format-detection" content="telephone=no" />
<meta name="format-detection" content="address=no" />
<meta name="format-detection" content="email=no" />
<meta name="format-detection" content="date=no" />
<title>Americano Machorras</title>

<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Machorras">

<link rel="apple-touch-icon" href="https://i.ibb.co/WN3Rx3fV/192.png">
<link rel="icon" type="image/png" href="https://i.ibb.co/WN3Rx3fV/192.png">

<script src="https://cdn.tailwindcss.com"></script>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

const supabaseUrl = "https://sxtgzpzneqyaxljpkqmb.supabase.co";
const supabaseAnonKey = "sb_publishable_mrrBNQvb9QKx4pfkSMoSuQ_IxtFSaaX";
const supabase = createClient(supabaseUrl, supabaseAnonKey);

let localResultados = {};

const startApp = async () => {
  try {
    const { data, error } = await supabase.from("resultados").select("*");
    if (error) throw error;
    localResultados = {};
    data.forEach((row) => {
      const rKey = row.ronda.toString();
      if (!localResultados[rKey]) localResultados[rKey] = {};
      localResultados[rKey][row.partido_idx] = row.scores;
    });
    window.initButtons();
    window.renderRonda(1);
    
    supabase.channel("changes").on("postgres_changes", { event: "*", schema: "public", table: "resultados" }, () => {
        startApp(); 
    }).subscribe();
  } catch (err) {
    window.initButtons();
    window.renderRonda(1);
  }
};

const initAuth = async () => {
  const { data: { session } } = await supabase.auth.getSession();
  if (!session) await supabase.auth.signInAnonymously();
  startApp();
};

initAuth();

window.setCurrentView = (type, value) => {
  if (type === "ronda") window.renderRonda(value);
  else window.renderClasificacion();
};

// --- LOGICA MODIFICADA PARA DECIMALES (PUNTO Y COMA) ---
window.saveScore = async (ronda, partidoIdx, parejaPos, value) => {
  // 1. Reemplazamos la coma por punto para que JS pueda calcular
  const valSanitized = value.toString().replace(',', '.');
  
  // 2. Guardamos como decimal (Float)
  const valFloat = valSanitized === "" ? null : parseFloat(valSanitized);
  
  const rKey = ronda.toString();
  if (!localResultados[rKey]) localResultados[rKey] = {};
  if (!localResultados[rKey][partidoIdx]) localResultados[rKey][partidoIdx] = [null, null];
  
  localResultados[rKey][partidoIdx][parejaPos] = valFloat;
  
  await supabase.from("resultados").upsert(
    { ronda, partido_idx: partidoIdx, scores: localResultados[rKey][partidoIdx] },
    { onConflict: "ronda,partido_idx" }
  );
};
// -------------------------------------------------------

window.clearMatch = async (ronda, partidoIdx) => {
  const rKey = ronda.toString();
  if (localResultados[rKey]) {
    localResultados[rKey][partidoIdx] = [null, null];
    await supabase.from("resultados").upsert({ ronda, partido_idx: partidoIdx, scores: [null, null] }, { onConflict: "ronda,partido_idx" });
    window.renderRonda(ronda);
  }
};

// --- DEFINICI√ìN DE PAREJAS ---
const parejas = {
  1: "Martina y Delfina",
  2: "Las Dejaditas Letales",
  3: "Chuchi‚Äôs Team",
  4: "Las Chinchillas",
  5: "The Twins",
  6: "Valkirias",
  7: "Gabinete Machorril",
  8: "Las PY",
  9: "Az√∫car Moreno",
  10: "Last Call",
  11: "Las de la √∫ltima bola",
  12: "Padeleo",
  13: "Golden Point",
  14: "Red Queens",
  15: "Las Rebotonas",
  16: "Bolitas",
  17: "Red Flag",
  18: "Zipi y Zape",
  19: "Two Strangers",
  20: "AR en la Red"
};

// --- DATOS DE RONDAS Y CRUCES ---
const rondasData = {
  1: { cruces: [[1,3], [2,4], [5,6], [7,8], [9,10], [11,12], [13,14], [15,16], [17,18], [19,20]] },
  2: { cruces: [[6,8], [1,4], [2,3], [5,7], [10,12], [9,11], [14,16], [17,19], [18,20], [13,15]] },
  3: { cruces: [[3,4], [11,13], [1,5], [2,6], [12,14], [7,9], [8,10], [15,17], [16,20], [18,19]] },
  4: { cruces: [[9,12], [10,11], [13,16], [3,7], [1,6], [4,8], [14,18], [15,19], [2,5], [17,20]] },
  5: { cruces: [[2,8], [12,18], [9,13], [1,7], [11,17], [3,5], [16,19], [4,6], [15,20], [10,14]] },
  6: { cruces: [[4,5], [10,13], [2,7], [9,14], [1,8], [11,19], [3,6], [12,20], [15,18], [16,17]] },
  7: { cruces: [[3,8], [1,9], [4,7], [5,11], [16,18], [6,15], [12,17], [2,10], [14,20], [13,19]] },
  8: { cruces: [[1,10], [7,17], [8,18], [4,12], [5,15], [3,11], [2,9], [6,16], [13,20], [14,19]] },
  9: { cruces: [[3,9], [2,12], [4,10], [8,20], [6,17], [14,15], [7,19], [1,11], [5,16], [13,18]] },
  10: { cruces: [[2,11], [4,13], [5,18], [7,15], [8,16], [9,20], [1,12], [14,17], [6,19], [3,10]] }
};

window.initButtons = () => {
  const container = document.getElementById("buttons-rondas");
  container.innerHTML = "";
  for (let i = 1; i <= 10; i++) {
    const btn = document.createElement("button");
    btn.id = `btn-${i}`;
    btn.onclick = () => window.setCurrentView("ronda", i);
    btn.className = "btn-ronda-base";
    btn.innerText = `R${i}`;
    container.appendChild(btn);
  }
};

window.renderRonda = (num) => {
  const container = document.getElementById("main-content");
  const data = rondasData[num];
  const rKey = num.toString();
  let html = `<div class="animate-fade-in pb-10">`;

  // Array con los nombres exactos de las pistas
  const nombresPistas = ["1", "2", "3", "5", "6", "7", "10", "11", "12", "13"];

  data.cruces.forEach((cruce, idx) => {
    const mS = (localResultados[rKey] && localResultados[rKey][idx]) ? localResultados[rKey][idx] : [null, null];
    // Convertir null a string vac√≠o para el input
    const s1 = (mS[0] !== null) ? mS[0] : "";
    const s2 = (mS[1] !== null) ? mS[1] : "";
    
    const pistaReal = nombresPistas[idx];

    html += `
      <div class="match-card">
        <div class="flex justify-between items-center mb-5">
            <span class="pista-label-pro">PISTA ${pistaReal}</span>
            <button class="reset-btn" onclick="window.clearMatch(${num},${idx})">BORRAR</button>
        </div>
        <div class="flex items-center justify-between mb-4">
          <span class="team-name">${parejas[cruce[0]]}</span>
          <input type="number" step="0.01" inputmode="decimal" placeholder="-" value="${s1}" oninput="window.saveScore(${num},${idx},0,this.value)">
        </div>
        <div class="flex items-center justify-between">
          <span class="team-name">${parejas[cruce[1]]}</span>
          <input type="number" step="0.01" inputmode="decimal" placeholder="-" value="${s2}" oninput="window.saveScore(${num},${idx},1,this.value)">
        </div>
      </div>`;
  });
  container.innerHTML = html + "</div>";
  updateNavUI(num);
};

window.renderClasificacion = () => {
  const container = document.getElementById("main-content");
  const stats = {};
  for (let i = 1; i <= 20; i++) stats[i] = { nombre: parejas[i], total: 0, jugados: 0 };
  Object.keys(localResultados).forEach(rKey => {
    Object.keys(localResultados[rKey]).forEach(pIdx => {
      // Protecci√≥n por si hay datos viejos
      if(rondasData[rKey] && rondasData[rKey].cruces[pIdx]) {
        const cruce = rondasData[rKey].cruces[pIdx];
        const s = localResultados[rKey][pIdx];
        if (s[0] !== null) { stats[cruce[0]].total += s[0]; stats[cruce[0]].jugados++; }
        if (s[1] !== null) { stats[cruce[1]].total += s[1]; stats[cruce[1]].jugados++; }
      }
    });
  });
  
  const sorted = Object.values(stats).sort((a, b) => b.total - a.total);
  
  let html = `<div class="ranking-container animate-fade-in"><table><thead><tr><th>#</th><th>PAREJA</th><th>PJ</th><th class="text-center">PTS</th></tr></thead><tbody>`;
  
  sorted.forEach((p, i) => {
    const medal = i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : i + 1;
    
    // VISUALIZACI√ìN: Convertimos el n√∫mero a string con 2 decimales y forzamos la COMA
    const puntosVisuales = p.total.toFixed(2).replace('.', ',');

    html += `<tr><td class="w-10 text-center font-black">${medal}</td><td class="font-bold text-sm uppercase"><span class="no-link">${p.nombre}</span></td><td class="text-center opacity-40 text-xs">${p.jugados}</td><td class="text-center font-black text-white text-xl pts-cell">${puntosVisuales}</td></tr>`;
  });
  container.innerHTML = html + "</tbody></table></div>";
  updateNavUI("ranking");
};

function updateNavUI(active) {
  document.querySelectorAll('.btn-ronda-base').forEach(b => b.classList.remove('active-ronda'));
  const activeBtn = document.getElementById(active === "ranking" ? 'btn-ranking' : `btn-${active}`);
  if (activeBtn) activeBtn.classList.add('active-ronda');
}
</script>

<style>
@import url("https://fonts.googleapis.com/css2?family=Fira+Sans:wght@900&family=Inter:wght@400;700;900&display=swap");

* { text-decoration: none !important; -webkit-tap-highlight-color: transparent; }

:root { 
    --green: #22c55e; 
    --dark-bg: #011a14; 
    --royal-pro-grad: linear-gradient(135deg, #1e3a8a 0%, #1e40af 50%, #111827 100%); 
}

body { background: var(--dark-bg); color: white; font-family: 'Inter', sans-serif; margin: 0; padding: 0; }

.header-main { background: radial-gradient(circle at top, #065f46 0%, #011a14 100%); padding: 4rem 1rem 3rem; text-align: center; }

.logo-box { 
    width: 120px; height: 120px; margin: 0 auto; 
    border-radius: 50%; border: 3px solid white; 
    overflow: hidden; display: flex; align-items: center; justify-content: center;
    box-shadow: 0 0 30px rgba(34, 197, 94, 0.4); background: white;
}
.logo-box img { 
    width: 100%; height: 100%; object-fit: cover; 
    transform: scale(1.7); 
}

.txt-green { color: var(--green); font-weight: 900; letter-spacing: 0.35em; font-size: 1rem; margin-top: 1.5rem; display: block; }
.txt-logo { font-family: 'Fira Sans', sans-serif; font-size: 3.4rem; line-height: 0.8; margin-top: 0.4rem; text-shadow: 4px 4px 15px rgba(0,0,0,0.6); }

.nav-box { position: sticky; top: 1rem; z-index: 100; margin: -1.5rem 1rem 2rem; background: rgba(1, 26, 20, 0.95); backdrop-filter: blur(20px); padding: 0.75rem; border-radius: 2rem; }
.nav-scroll { display: flex; gap: 0.5rem; overflow-x: auto; scrollbar-width: none; }
.nav-scroll::-webkit-scrollbar { display: none; }

.btn-ronda-base { background: rgba(255,255,255,0.08); padding: 0.8rem 1.4rem; border-radius: 1.2rem; font-size: 11px; font-weight: 900; color: rgba(255,255,255,0.7); border: none; }
.active-ronda { background: var(--green) !important; color: #000 !important; box-shadow: 0 10px 20px rgba(34, 197, 94, 0.4); }

.pista-label-pro { background: rgba(255,255,255,0.15); padding: 0.6rem 1.2rem; border-radius: 1.2rem; font-size: 11px; font-weight: 900; color: white; letter-spacing: 0.05em; }

.match-card { background: var(--royal-pro-grad); border-radius: 1.8rem; padding: 1.6rem; margin-bottom: 1.4rem; box-shadow: 0 15px 35px rgba(0,0,0,0.4); border: none; }

.team-name { font-size: 16px; font-weight: 700; color: white; letter-spacing: -0.01em; }

/* MODIFICADO: GROSOR M√ÅXIMO (900) Y SOMBRA PARA REFORZAR */
input { 
    width: 74px; height: 48px; background: white !important; color: #000 !important; 
    text-align: center; border-radius: 1rem; font-weight: 900; font-size: 24px; border: none;
    text-shadow: 0.5px 0 0 #000, -0.5px 0 0 #000;
}

.reset-btn { color: white; opacity: 0.3; font-size: 10px; font-weight: 900; border: none; }

.ranking-container { background: var(--royal-pro-grad); border-radius: 1.8rem; overflow: hidden; box-shadow: 0 15px 35px rgba(0,0,0,0.4); margin-bottom: 2rem; }
.ranking-container table { width: 100%; border-collapse: collapse; }
.ranking-container td { padding: 20px 12px; border-bottom: 1px solid rgba(255,255,255,0.05); }
.ranking-container tr:last-child td { border-bottom: none; }
.ranking-container th { padding: 15px; font-size: 10px; opacity: 0.5; letter-spacing: 0.2em; color: white; font-weight: 900; }
.no-link { color: white !important; }
.pts-cell { text-align: center !important; color: white !important; }

.animate-fade-in { animation: fadeIn 0.4s ease-out; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
</style>
</head>
<body>
  <header class="header-main">
    <div class="logo-box">
      <img src="https://i.ibb.co/ymqrcjXM/512.png" alt="Logo">
    </div>
    <span class="txt-green">AMERICANO</span>
    <h1 class="txt-logo text-white">MACHORRAS</h1>
  </header>

  <nav class="nav-box">
    <div class="nav-scroll" id="buttons-rondas"></div>
    <button onclick="window.setCurrentView('ranking')" id="btn-ranking" class="btn-ronda-base w-full mt-4 uppercase tracking-[0.2em]">Clasificaci√≥n</button>
  </nav>

  <main id="main-content" class="p-4"></main>
</body>
</html>
